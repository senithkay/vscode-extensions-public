# Build and push the code server image using the given Ballerina distribution deb uri and the given VSIX uri.
name: Daily Code Server Image 2

on:
  workflow_dispatch:
    inputs:
      vsix_uri:
        description: Ballerina VSIX uri
        required: true
        default: https://github.com/wso2/ballerina-plugin-vscode/releases/download/v2x-2021-11-17/ballerina.vsix
      vsix_name:
        description: Ballerina VSIX name
        required: true
        default: ballerina.vsix
      ballerina_dist_uri:
        description: Ballerina distrbution deb uri
        required: true
        default: https://github.com/ballerina-platform/ballerina-distribution/releases/download/vswan-lake-beta4-rc3/ballerina-linux-installer-x64-swan-lake-beta4.deb
      ballerina_dist_name:
        description: Ballerina distrbution deb name
        required: true
        default: ballerina-linux-installer-x64-swan-lake-beta4.deb
    branches: [master]

jobs:
  build_docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y%m%d.%H%M')"
      - name: Docker Build and Push
        uses: docker/build-push-action@v2
        with:
          context: .
          file: .github/workflows/resources/code-server/2/Dockerfile
          platforms: linux/amd64
          push: true
          tags: prabushi/lowcode-code-server:0.${{ steps.date.outputs.date }}
          build-args: |
            BALLERINA_DEB_URI=${{ github.event.inputs.ballerina_dist_uri }}
            BALLERINA_VSIX_URI=${{ github.event.inputs.vsix_uri }}
            BALLERINA_DEB_NAME=${{ github.event.inputs.ballerina_dist_name }}
            BALLERINA_VSIX_NAME=${{ github.event.inputs.vsix_name }}
