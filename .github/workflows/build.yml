name: Build and run Tests

on: 
  workflow_call:
    inputs: 
      isPreRelease:
        default: true
        type: boolean      
      version:
        default: 'N/A'
        type: string
        required: false

env:
  ballerina_version: 2201.3.1
  ballerina_zip_url: https://github.com/ballerina-platform/ballerina-distribution/releases/download/v2201.3.1/ballerina-2201.3.1-swan-lake.zip
  ballerina_deb_url: https://dist.ballerina.io/downloads/2201.3.1/ballerina-2201.3.1-swan-lake-linux-x64.deb

jobs:
  Build_Stage:
    name: Build repo
    timeout-minutes: 45
    runs-on: ubuntu-latest
    outputs:
      runBalPluginTests: ${{ steps.testMatrix.outputs.runBalPluginTests }}
      testArray: ${{ steps.testMatrix.outputs.testArray }}
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.BALLERINA_BOT_TOKEN }}
          fetch-depth: 2

      - name: Setup
        uses: gigara/rush-cache@v1
        with:
          pnpm: 7.26.3
          node: 16.x
          set-env: true
          rush-install: true

      - uses: ballerina-platform/setup-ballerina@v1
        name: Install Ballerina
        with:
          version: ${{ env.ballerina_version }}

      - name: Update versions
        if: ${{ inputs.version != 'N/A' }}
        run: |
          npm version ${{ inputs.version }} --preid beta --no-git-tag-version
          npm version ${{ inputs.version }} --preid beta --no-git-tag-version --workspace=workspaces/choreo-extension
          
      - name: Get timestamp
        id: timestamp
        run: |
          timestamp=$(date '+%Y%m%d%H')
          echo "timestamp=$timestamp" >> $GITHUB_OUTPUT

      - name: Set prerelase version - ballerina
        if: ${{ inputs.isPreRelease }}
        run: |
          cd workspaces/ballerina-extension
          currentVersion=$(node -p "require('./package.json').version")
          currentVersionWOPreId=${currentVersion%-*}
          currentVersionNo=${currentVersionWOPreId%.*}
          newVersion=${currentVersionNo}.${{ steps.timestamp.outputs.timestamp }}
          echo $newVersion
          npm version $newVersion --preid beta --no-git-tag-version
          
      - name: Set prerelase version - choreo
        if: ${{ inputs.isPreRelease }}
        run: |
          cd workspaces/choreo-extension
          currentVersion=$(node -p "require('./package.json').version")
          currentVersionWOPreId=${currentVersion%-*}
          currentVersionNo=${currentVersionWOPreId%.*}
          newVersion=${currentVersionNo}.${{ steps.timestamp.outputs.timestamp }}
          echo $newVersion
          npm version $newVersion --preid beta --no-git-tag-version

      - name: Build repo
        id: build
        run: |
          node common/scripts/install-run-rush.js build --verbose
        env:
          isPreRelease: ${{ inputs.isPreRelease  }}

      - name: Set test matrix
        id: testMatrix
        run: |
          # Get list of all changed files in the PR
          CHANGED_DIRS=$(git diff --name-only HEAD^..HEAD | grep -E "^workspaces/*" || true)

          # Loop through each directory and extract the folder name
          FOLDERS=()
          i=0
          while read -r dir; do
            # Extract the top-level folder name by removing the first path segment ('workspaces/') and the trailing slash (if any)
            folder=$(echo "$dir" | cut -d / -f 2 | sed 's/\/$//')
            # Add the folder name to the array if it hasn't been added already
            if ! [[ "${FOLDERS[@]}" =~ "$folder" ]]; then
              FOLDERS+=("$folder")
            fi
          done <<< "$CHANGED_DIRS"

          tests=()

          echo "Changed workspaces: $FOLDERS"
          if [[ "${FOLDERS[@]}" =~ "ballerina-extension" ]]; then
            echo "runBalPluginTests=true" >> $GITHUB_OUTPUT
          fi 

          if [[ "${FOLDERS[@]}" =~ "low-code-diagram" ]] || [[ "${FOLDERS[@]}" =~ "low-code-editor" ]]; then
            tests+=( "test-connectors" "test-block-level" "test-module-level" "test-entry-points");
          fi 

          if [[ "${FOLDERS[@]}" =~ "ballerina-languageclient" ]] || 
          [[ "${FOLDERS[@]}" =~ "expression-editor" ]] || 
          [[ "${FOLDERS[@]}" =~ "lang-service" ]] || 
          [[ "${FOLDERS[@]}" =~ "low-code-editor-commons" ]] || 
          [[ "${FOLDERS[@]}" =~ "low-code-ui-components" ]] || 
          [[ "${FOLDERS[@]}" =~ "statement-editor" ]] || 
          [[ "${FOLDERS[@]}" =~ "syntax-tree" ]]; then
            tests+=( "test-connectors" "test-block-level" "test-module-level" "test-entry-points" "test-se" "test-se-tools" "test-dm");
          fi 

          sortedTests=$("${tests[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          testArray="["
          for test in "${sortedTests[@]}"; do
            testArray+="'$test',"
          done
          testArray=${testArray:0: -1}
          testArray+="]"
          if [ ${#tests[@]} = 0 ]; then testArray='false'; fi
          echo $testArray
          echo "testArray=$testArray" >> $GITHUB_OUTPUT

      - name: Compress build
        run: |
          zip -r build.zip ./ -x 'common/temp*' -y
          zip VSIX.zip *.vsix

      - name: Save VSIX
        uses: actions/upload-artifact@v3
        with:
          path: VSIX.zip
          name: VSIX

      - name: Save build
        uses: actions/upload-artifact@v3
        with:
          path: build.zip
          name: PluginBuild

  PluginTest_Stage:
    name: Run Plugin test
    needs: Build_Stage
    if: ${{ !inputs.isPreRelease || needs.Build_Stage.outputs.runBalPluginTests }}
    timeout-minutes: 30
    runs-on: ubuntu-latest
    steps:
      - name: Restore build
        uses: actions/download-artifact@v3
        with:
          name: PluginBuild
          path: ./

      - name: Set up workspace
        run: |
          unzip build.zip
          rm build.zip

      - name: Setup
        uses: gigara/rush-cache@v1
        with:
          pnpm: 7.26.3
          node: 16.x
          rush-install: true

      - name: Set up Ballerina
        run: |
          cd workspaces/ballerina-extension
          mkdir extractedDistribution
          wget ${{ env.ballerina_zip_url }}
          unzip -qq ./ballerina-${{ env.ballerina_version }}-swan-lake.zip -d ./extractedDistribution
          rm ballerina-${{ env.ballerina_version }}-swan-lake.zip
          balVersion=$(ls ./extractedDistribution)
          balHome=./extractedDistribution/$balVersion

          echo "$balHome/bin" >> $GITHUB_PATH

      - name: Run Test
        run: |
          cd workspaces/ballerina-extension
          xvfb-run --auto-servernum pnpm run test
        env:
          balVersion: ${{ steps.set-version.outputs.balVersion }}
          balHome: ${{ steps.set-version.outputs.balHome }}

      - name: Convert lcov to cobertura
        run: |
          cd workspaces/ballerina-extension
          python lcov_cobertura.py coverage/lcov.info -b src/ -o coverage/coverage.xml

      - name: Publish coverage reports
        uses: actions/upload-artifact@v3
        with:
          path: workspaces/ballerina-extension/coverage
          name: vscode-extension-coverage-${{ github.run_attempt }}
        if: always()
    
      - name: Rename code coverage file
        run: mv workspaces/ballerina-extension/coverage/coverage.xml workspaces/ballerina-extension/coverage/plugin-coverage.xml
    
      - name: Publish partial code coverage
        uses: actions/upload-artifact@v3
        with:
          path: workspaces/ballerina-extension/coverage/plugin-coverage.xml
          name: CodeCoverages

  UiTest_Stage:
    name: Run UI tests
    needs: Build_Stage
    if: ${{ !inputs.isPreRelease || needs.Build_Stage.outputs.runBalPluginTests }}
    timeout-minutes: 45
    runs-on: ubuntu-latest
    steps:
      - name: Restore build
        uses: actions/download-artifact@v3
        with:
          name: PluginBuild
          path: ./

      - name: Set up workspace
        run: |
          unzip build.zip
          rm build.zip

      - name: Setup
        uses: gigara/rush-cache@v1
        with:
          pnpm: 7.26.3
          node: 16.x
          rush-install: true

      - uses: ballerina-platform/setup-ballerina@v1
        name: Install Ballerina
        with:
          version: ${{ env.ballerina_version }}

      - name: UI Test
        run: |
          cd workspaces/ballerina-extension
          sudo apt-get install xvfb
          pnpm run ui-test-setup
          export DISPLAY=:98.0
          Xvfb -ac :98 -screen 0 1920x1080x16 & pnpm run ui-test

      - name: Publish UI Test Screenshots
        uses: actions/upload-artifact@v3
        with:
          path: workspaces/ballerina-extension/test-resources/screenshots/
          name: Ui-test-screenshots-${{ github.run_attempt }}
        if: failure()

  LowCode_Test_Stage:
    name: Run low code tests
    needs: Build_Stage
    if: ${{ !inputs.isPreRelease || needs.Build_Stage.outputs.testArray != 'false' }}
    strategy:
      fail-fast: false
      matrix:
        testStage: ${{ fromJSON(needs.Build_Stage.outputs.testArray) }}
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - name: Restore build
        uses: actions/download-artifact@v3
        with:
          name: PluginBuild
          path: ./

      - name: Set up workspace
        run: |
          unzip build.zip
          rm build.zip

      - name: Setup
        uses: gigara/rush-cache@v1
        with:
          pnpm: 7.26.3
          node: 16.x
          rush-install: true

      - name: Install Cypress Dependencies
        run: sudo apt-get install libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb

      - uses: ballerina-platform/setup-ballerina@v1
        name: Install Ballerina
        with:
          version: ${{ env.ballerina_version }}

      - name: Install Chrome Stable Version
        run: |
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb

      - name: Run Integration Tests
        run: |
          cd workspaces/low-code-integration-tests  
          npm run ${{ matrix.testStage  }}

      - name: Publish test fail screenshots
        uses: actions/upload-artifact@v3
        with:
          path: workspaces/low-code-integration-tests/cypress/screenshots
          name: low-code-cypress-screenshots-${{ matrix.testStage  }}-${{ github.run_attempt }}
        if: failure()
      
      - name: Rename code coverage file
        run: mv workspaces/low-code-integration-tests/.nyc_output/out.json workspaces/low-code-integration-tests/.nyc_output/${{ matrix.testStage  }}.json
      
      - name: Publish partial code coverage
        uses: actions/upload-artifact@v3
        with:
          path: workspaces/low-code-integration-tests/.nyc_output/${{ matrix.testStage  }}.json
          name: CodeCoverages

      - name: Publish test videos
        uses: actions/upload-artifact@v3
        with:
          path: workspaces/low-code-integration-tests/cypress/videos
          name: low-code-cypress-recordings-${{ matrix.testStage  }}-${{ github.run_attempt }}
        if: failure()
    
      - name: Publish test failure console logs
        uses: actions/upload-artifact@v3
        with:
          path: workspaces/low-code-integration-tests/logs
          name: low-code-cypress-failure-test-logs-${{ matrix.testStage  }}-${{ github.run_attempt }}
        if: failure()

  Publish_Coverage_Resuls_Stage:
    name: Publish code coverage results
    needs: [Build_Stage, PluginTest_Stage, UiTest_Stage, LowCode_Test_Stage]
    timeout-minutes: 5
    runs-on: ubuntu-latest
    steps:
      - name: Restore build
        uses: actions/download-artifact@v3
        with:
          name: PluginBuild
          path: ./

      - name: Set up workspace
        run: |
          unzip build.zip
          rm build.zip

      - name: Setup
        uses: gigara/rush-cache@v1
        with:
          pnpm: 7.26.3
          node: 16.x
          rush-install: true

      - name: Download partial code coverages
        uses: actions/download-artifact@v3
        with:
          name: CodeCoverages
          path: ./coverageData

      - name: "Publish total code coverage"
        run: |
          npx nyc merge coverageData
          mkdir workspaces/low-code-integration-tests/.nyc_output
          mv coverage.json workspaces/low-code-integration-tests/.nyc_output/out.json
          npx nyc report --reporter html --reporter cobertura -t workspaces/low-code-integration-tests/.nyc_output --report-dir workspaces/low-code-integration-tests/coverage
        if: always()

      - run: |
          mkdir totalCoverage
          echo ${{ github.event.number }} | tee ./totalCoverage/number
          mv workspaces/low-code-integration-tests/coverage/cobertura-coverage.xml totalCoverage/lowcode-coverage.xml 

      - name: Publish code coverage
        uses: actions/upload-artifact@v3
        with:
          path: totalCoverage
          name: CodeCoverages    
