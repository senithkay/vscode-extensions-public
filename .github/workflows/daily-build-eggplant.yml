name: Daily Build - Eggplant
on:
  schedule:
    - cron:  '45 09 * * *'
jobs:
  Build:
    uses: ./.github/workflows/build.yml
    secrets: inherit
    with:
       eggplant: true
       isReleaseBuild: false

  Release:
    name: Release VSIX
    needs: Build
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - name: Restore build
        uses: actions/download-artifact@v3
        with:
            name: ExtBuild
            path: ./

      - name: Set up workspace
        run: |
            unzip build.zip
            rm build.zip

      - name: Get version
        id: vsix
        run: |
            file=$(ls eggplant*.vsix)
            fileName=${file##*-}
            version=$version+eggplant-${fileName%.*}  

            echo $version
            echo "version=$version" >> $GITHUB_OUTPUT
            echo "fileName=$file" >> $GITHUB_OUTPUT

      - name: Save VSIX
        uses: actions/upload-artifact@v4
        id: artifact-upload
        with:
          path: ${{ steps.vsix.outputs.fileName }}
          name: Vsix-Artifact

      - name: "Release Notification"
        shell: bash
        run: |
            body=$(cat << EOF
            {
            "cards": [
                { 
                "header": {
                    "title": "Daily Build",
                },
                "sections": [
                    {
                    "widgets": [
                        {
                        "keyValue": {
                            "topLabel": "Eggplant",
                            "content": "v${{ steps.vsix.outputs.version }}",
                            "onClick": {
                            "openLink": {
                                "url": "https://github.com/wso2-enterprise/vscode-extensions/actions/runs/${{ github.run_id }}"
                            }
                            },": "https://upl
                                    oad.wikimedia.org/wikipedia/commons/thumb/9/9a/Visual_Studio_Code_1.35_icon.svg/512px-Visual_Studio_Code_1.35_icon.svg.png",
                            "button": {
                            "textButton": {
                                "text": "Download VSIX",
                                "onClick": {
                                "openLink": {
                                    "url": "${{ steps.artifact-upload.outputs.artifact-url }}"
                                }
                                }
                            }
                            }
                        }
                        }
                    ]
                    }
                ]
                }
            ]
            }
            EOF
            )
            curl \
            -X POST \
            -H 'Content-Type: application/json' \
            "https://chat.googleapis.com/v1/spaces/AAAAf3Fb5uM/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=_fJy_LdAUcLrK-4ooNSUi8s3V-D50xVtgwsXh46fBJ8" \
            -d "$body"
